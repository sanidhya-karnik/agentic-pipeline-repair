<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Pipeline Repair</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: #1a2035;
            --bg-card-hover: #1f2a42;
            --border: #2a3550;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-green: #10b981;
            --accent-green-dim: rgba(16, 185, 129, 0.15);
            --accent-red: #ef4444;
            --accent-red-dim: rgba(239, 68, 68, 0.15);
            --accent-yellow: #f59e0b;
            --accent-yellow-dim: rgba(245, 158, 11, 0.15);
            --accent-blue: #3b82f6;
            --accent-blue-dim: rgba(59, 130, 246, 0.15);
            --accent-purple: #8b5cf6;
            --accent-purple-dim: rgba(139, 92, 246, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .refresh-btn { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            color: var(--text-secondary); 
            padding: 8px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 13px;
            font-family: 'Outfit', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        .refresh-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); border-color: var(--accent-blue); }
        .refresh-btn:active { transform: scale(0.97); }
        .refresh-btn.loading svg { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback } = React;

const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:8000' : `http://${window.location.hostname}:8000`;

function RefreshIcon() {
    return React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('path', { d: 'M21 2v6h-6' }),
        React.createElement('path', { d: 'M3 12a9 9 0 0 1 15-6.7L21 8' }),
        React.createElement('path', { d: 'M3 22v-6h6' }),
        React.createElement('path', { d: 'M21 12a9 9 0 0 1-15 6.7L3 16' }));
}

function Badge({ status }) {
    const m = { HEALTHY:['var(--accent-green)','var(--accent-green-dim)','Healthy'], FAILED:['var(--accent-red)','var(--accent-red-dim)','Failed'], SLA_BREACHED:['var(--accent-yellow)','var(--accent-yellow-dim)','SLA Breach'], RUNNING:['var(--accent-blue)','var(--accent-blue-dim)','Running'], success:['var(--accent-green)','var(--accent-green-dim)','Success'], failed:['var(--accent-red)','var(--accent-red-dim)','Failed'], running:['var(--accent-blue)','var(--accent-blue-dim)','Running'] };
    const [c,b,l] = m[status] || ['var(--text-muted)','transparent',status];
    return React.createElement('span', { style: { display:'inline-flex', alignItems:'center', gap:6, padding:'3px 10px', borderRadius:20, fontSize:12, fontWeight:600, color:c, background:b } },
        React.createElement('span', { style: { width:6, height:6, borderRadius:'50%', background:c, boxShadow:`0 0 6px ${c}` } }), l);
}

function PipelineCard({ p }) {
    const st = p.error_message ? 'FAILED' : p.last_run_status==='running' ? 'RUNNING' : p.duration_seconds > (p.sla_minutes||30)*60 ? 'SLA_BREACHED' : 'HEALTHY';
    const tier = p.pipeline_name.startsWith('raw') ? 'SOURCE' : p.pipeline_name.startsWith('stg') ? 'STAGING' : 'MART';
    const tc = tier==='SOURCE' ? 'var(--accent-blue)' : tier==='STAGING' ? 'var(--accent-purple)' : 'var(--accent-green)';
    return React.createElement('div', { style: { background:'var(--bg-card)', border:'1px solid var(--border)', borderRadius:10, padding:16 } },
        React.createElement('div', { style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:10} },
            React.createElement('div', null,
                React.createElement('span', { className:'mono', style:{fontSize:11,fontWeight:600,color:tc,letterSpacing:1,textTransform:'uppercase'} }, tier),
                React.createElement('div', { className:'mono', style:{fontSize:14,fontWeight:600,marginTop:4} }, p.pipeline_name)),
            React.createElement(Badge, { status:st })),
        p.error_message && React.createElement('div', { className:'mono', style:{fontSize:11,color:'var(--accent-red)',marginTop:8,lineHeight:1.4,background:'var(--accent-red-dim)',padding:'6px 8px',borderRadius:6,maxHeight:60,overflow:'hidden'} }, p.error_message),
        React.createElement('div', { style:{display:'flex',gap:16,marginTop:10,fontSize:12,color:'var(--text-secondary)'} },
            React.createElement('span', null, 'Duration: ', React.createElement('span', {className:'mono'}, p.duration_seconds?`${p.duration_seconds}s`:'-')),
            React.createElement('span', null, 'Rows: ', React.createElement('span', {className:'mono'}, p.last_run_rows?p.last_run_rows.toLocaleString():'-'))));
}

function DAG({ pipelines }) {
    const d = { s:pipelines.filter(p=>p.pipeline_name.startsWith('raw')), t:pipelines.filter(p=>p.pipeline_name.startsWith('stg')), m:pipelines.filter(p=>p.pipeline_name.startsWith('mart')) };
    function N({name,status}) {
        const c = status==='failed'?'var(--accent-red)':status==='running'?'var(--accent-blue)':'var(--accent-green)';
        return React.createElement('div', { style:{background:'var(--bg-card)',border:`1px solid ${c}`,borderRadius:6,padding:'6px 12px',fontSize:11,fontFamily:"'JetBrains Mono',monospace",fontWeight:500,color:c,textAlign:'center',minWidth:120,boxShadow:`0 0 8px ${c}22`} },
            name.replace('raw_','').replace('stg_','').replace('mart_',''));
    }
    const A = () => React.createElement('div', { style:{color:'var(--text-muted)',fontSize:18,margin:'0 8px'} }, '\u2192');
    return React.createElement('div', { style:{background:'var(--bg-card)',borderRadius:10,border:'1px solid var(--border)',padding:20} },
        React.createElement('div', { style:{fontSize:13,fontWeight:600,color:'var(--text-secondary)',marginBottom:16,letterSpacing:0.5,textTransform:'uppercase'} }, 'Pipeline DAG'),
        React.createElement('div', { style:{display:'flex',alignItems:'center',justifyContent:'center',gap:12,flexWrap:'wrap'} },
            React.createElement('div', { style:{textAlign:'center'} },
                React.createElement('div', { style:{fontSize:10,color:'var(--accent-blue)',fontWeight:600,marginBottom:8,letterSpacing:1} }, 'SOURCE'),
                React.createElement('div', { style:{display:'flex',flexDirection:'column',gap:6} }, ...d.s.map(p=>React.createElement(N, {key:p.pipeline_name,name:p.pipeline_name,status:p.last_run_status})))),
            React.createElement(A),
            React.createElement('div', { style:{textAlign:'center'} },
                React.createElement('div', { style:{fontSize:10,color:'var(--accent-purple)',fontWeight:600,marginBottom:8,letterSpacing:1} }, 'STAGING'),
                React.createElement('div', { style:{display:'flex',flexDirection:'column',gap:6} }, ...d.t.map(p=>React.createElement(N, {key:p.pipeline_name,name:p.pipeline_name,status:p.last_run_status})))),
            React.createElement(A),
            React.createElement('div', { style:{textAlign:'center'} },
                React.createElement('div', { style:{fontSize:10,color:'var(--accent-green)',fontWeight:600,marginBottom:8,letterSpacing:1} }, 'MARTS'),
                React.createElement('div', { style:{display:'flex',flexDirection:'column',gap:6} }, ...d.m.map(p=>React.createElement(N, {key:p.pipeline_name,name:p.pipeline_name,status:p.last_run_status}))))));
}

function Stats({ pipelines }) {
    const t=pipelines.length, h=pipelines.filter(p=>!p.error_message&&p.last_run_status!=='running').length, f=pipelines.filter(p=>p.error_message||p.last_run_status==='failed').length, r=pipelines.filter(p=>p.last_run_status==='running').length;
    const S = ({label,value,color}) => React.createElement('div', { style:{background:'var(--bg-card)',borderRadius:10,border:'1px solid var(--border)',padding:'16px 20px',flex:1,minWidth:140} },
        React.createElement('div', { style:{fontSize:11,color:'var(--text-muted)',textTransform:'uppercase',letterSpacing:1,fontWeight:600,marginBottom:6} }, label),
        React.createElement('div', { className:'mono', style:{fontSize:28,fontWeight:700,color} }, value));
    return React.createElement('div', { style:{display:'flex',gap:12,flexWrap:'wrap'} },
        React.createElement(S, {label:'Total Pipelines',value:t,color:'var(--text-primary)'}),
        React.createElement(S, {label:'Healthy',value:h,color:'var(--accent-green)'}),
        React.createElement(S, {label:'Failed',value:f,color:'var(--accent-red)'}),
        React.createElement(S, {label:'Running',value:r,color:'var(--accent-blue)'}));
}

function App() {
    const [pipelines, setPipelines] = useState([]);
    const [loading, setLoading] = useState(true);
    const [refreshing, setRefreshing] = useState(false);
    const [error, setError] = useState(null);
    const [lastRefresh, setLastRefresh] = useState(null);

    const fetchData = useCallback(async (isManual = false) => {
        if (isManual) setRefreshing(true);
        try {
            const res = await fetch(`${API}/pipelines`);
            const data = await res.json();
            setPipelines(data.pipelines || []);
            setError(null);
            setLastRefresh(new Date());
        } catch(e) { setError('API disconnected'); }
        setLoading(false);
        if (isManual) setTimeout(() => setRefreshing(false), 500);
    }, []);

    useEffect(() => { fetchData(); const iv = setInterval(fetchData, 10000); return ()=>clearInterval(iv); }, [fetchData]);

    if (loading) return React.createElement('div', { style:{display:'flex',alignItems:'center',justifyContent:'center',minHeight:'100vh',fontSize:16,color:'var(--text-muted)'} }, 'Connecting to Agentic Pipeline Repair API...');

    return React.createElement('div', { style:{maxWidth:1280,margin:'0 auto',padding:'24px 20px'} },
        // Header
        React.createElement('div', { style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:28} },
            React.createElement('div', null,
                React.createElement('h1', { style:{fontSize:22,fontWeight:700,letterSpacing:-0.5} }, 'Agentic Pipeline Repair'),
                React.createElement('div', { style:{fontSize:13,color:'var(--text-muted)',marginTop:2} }, 'Multi-agent data pipeline monitoring powered by Amazon Nova 2 Lite')),
            React.createElement('div', { style:{display:'flex',gap:12,alignItems:'center'} },
                error && React.createElement('span', { style:{fontSize:12,color:'var(--accent-red)',marginRight:8} }, error),
                lastRefresh && React.createElement('span', { className:'mono', style:{fontSize:11,color:'var(--text-muted)'} }, `Updated ${lastRefresh.toLocaleTimeString()}`),
                React.createElement('div', { style:{width:8,height:8,borderRadius:'50%',background:error?'var(--accent-red)':'var(--accent-green)',boxShadow:`0 0 6px ${error?'var(--accent-red)':'var(--accent-green)'}`} }),
                React.createElement('button', { className: `refresh-btn ${refreshing ? 'loading' : ''}`, onClick: () => fetchData(true) },
                    React.createElement(RefreshIcon),
                    'Refresh'))),

        // Content
        React.createElement('div', { className:'fade-in' },
            React.createElement(Stats, { pipelines }),
            React.createElement('div', { style:{marginTop:20} }, React.createElement(DAG, { pipelines })),
            React.createElement('div', { style:{marginTop:20} },
                React.createElement('div', { style:{fontSize:13,fontWeight:600,color:'var(--text-secondary)',marginBottom:12,letterSpacing:0.5,textTransform:'uppercase'} }, 'Pipelines'),
                React.createElement('div', { style:{display:'grid',gridTemplateColumns:'repeat(auto-fill, minmax(340px, 1fr))',gap:12} },
                    pipelines.map(p => React.createElement(PipelineCard, { key:p.pipeline_name||p.pipeline_id, p }))))));
}

ReactDOM.render(React.createElement(App), document.getElementById('root'));
</script>
</body>
</html>
